# Migration System

Guide to Tenjin's migration system and workflow.

## Overview

Tenjin integrates with Supabase's native migration system while providing Elixir DSL convenience:

1. **Tenjin** generates SQL from your Elixir schema definitions
2. **Supabase CLI** manages migration files and database operations
3. **Your workflow** remains database-first and version-controlled

## Basic Workflow

### 1. Define Your Schema
```elixir
# lib/my_app/schema.ex
defmodule MyApp.Schema do
  use Tenjin.Schema
  
  table "users" do
    field :id, :uuid, primary_key: true, default: "gen_random_uuid()"
    field :email, :text, unique: true, null: false
    # ... more fields
  end
end
```

### 2. Generate Migration
```bash
mix tenjin.gen.migration initial_schema
```

This creates a timestamped SQL file in `supabase/migrations/` with the generated DDL.

### 3. Apply Migration
```bash
mix tenjin.migrate --local  # Apply to local database
mix tenjin.migrate          # Apply to linked Supabase project
```

## Migration Files

Generated migration files look like:
```sql
-- Tenjin schema migration
-- Created: 2025-01-11T01:51:02.269789Z
-- Generated by: Tenjin Framework

CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text UNIQUE NOT NULL,
  name text,
  created_at timestamptz DEFAULT now()
);

ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY users_select_users_can_view ON users
  FOR SELECT
  USING (auth.uid() = id);
```

## Development Workflow

### Iterative Development
1. Modify your schema in Elixir
2. Generate new migration: `mix tenjin.gen.migration add_posts`
3. Review the generated SQL
4. Apply: `mix tenjin.migrate --local`
5. Test your changes
6. Commit both schema and migration files

### Schema Changes
For schema modifications, generate a new migration rather than editing existing ones:

```bash
# After adding new tables/fields to schema.ex
mix tenjin.gen.migration add_user_profiles

# After modifying existing tables
mix tenjin.gen.migration update_user_fields
```

## Local Development

### Start Supabase
```bash
mix tenjin.supabase.start
```

### Reset Database
```bash
supabase db reset  # Resets and reapplies all migrations
```

### Check Status
```bash
mix tenjin.supabase.status
```

## Production Deployment

### Link to Supabase Project
```bash
supabase link --project-ref your-project-ref
```

### Deploy Migrations
```bash
supabase db push  # Deploy to production
```

## Best Practices

1. **Always Review Generated SQL** - Check the migration file before applying
2. **Test Locally First** - Use `--local` flag for development
3. **Backup Before Production** - Always backup before deploying to production
4. **Version Control Everything** - Commit both schema files and migrations
5. **Incremental Changes** - Make small, focused migrations rather than large ones
6. **Name Descriptively** - Use clear migration names that describe the change

## Troubleshooting

### Migration Fails
- Check SQL syntax in the generated migration file
- Ensure prerequisites (referenced tables, etc.) exist
- Review Supabase logs for detailed error messages

### Schema Out of Sync
- Compare your Elixir schema with actual database schema
- Generate a new migration to bring them in sync
- Use `supabase db diff` to see current differences